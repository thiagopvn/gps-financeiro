<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Registro de Horas - GPS Financeiro</title>
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png"/>
    <!-- Resource Hints -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <!-- Theme Persistence -->
    <script src="/shared/theme.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/shared/styles.css"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/shared/tailwind-config.js"></script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white overflow-hidden h-screen flex flex-col">
    <!-- Main Content Wrapper -->
    <div class="flex-1 overflow-y-auto no-scrollbar pb-40">
        <!-- Header -->
        <div class="sticky top-0 z-10 flex items-center bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md p-4 pb-2 justify-between border-b border-black/5 dark:border-white/5">
            <a href="/user/Dashboard/dash.html" class="text-slate-900 dark:text-white flex size-12 shrink-0 items-center justify-start cursor-pointer transition-colors hover:text-primary">
                <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back_ios</span>
            </a>
            <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Registro de Ponto</h2>
            <div class="flex w-12 items-center justify-end">
                <a href="/user/configuracoes/config.html" class="flex items-center justify-center rounded-lg h-12 text-slate-900 dark:text-white hover:text-primary transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">settings</span>
                </a>
            </div>
        </div>

        <!-- Timer Section -->
        <div class="flex flex-col items-center justify-center pt-8 pb-6 px-6">
            <!-- Status Headline -->
            <div class="mb-8 text-center">
                <div id="statusBadge" class="inline-flex items-center justify-center px-3 py-1 rounded-full bg-slate-200 dark:bg-surface-dark mb-3">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-slate-400 mr-2"></div>
                    <span id="statusLabel" class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Status Atual</span>
                </div>
                <h3 id="statusText" class="text-slate-900 dark:text-white tracking-tight text-3xl font-bold leading-tight">Você está offline</h3>
                <p id="currentDate" class="text-slate-500 dark:text-slate-400 text-sm mt-1"></p>
            </div>

            <!-- Timer Display -->
            <div class="w-full max-w-sm">
                <div class="flex gap-3 justify-center">
                    <!-- Hours -->
                    <div class="flex flex-col items-center gap-2 flex-1">
                        <div class="w-full aspect-[4/5] flex items-center justify-center rounded-2xl bg-white dark:bg-zinc-800 shadow-sm ring-1 ring-black/5 dark:ring-white/5 relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-br from-transparent to-black/5 dark:to-black/20"></div>
                            <p id="hours" class="text-slate-900 dark:text-primary text-5xl sm:text-6xl font-black leading-none tracking-tighter relative z-10 tabular-nums">00</p>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider">Horas</p>
                    </div>
                    <!-- Separator -->
                    <div class="flex flex-col justify-start pt-6 h-full">
                        <span id="sep1" class="text-slate-300 dark:text-slate-600 text-4xl font-bold">:</span>
                    </div>
                    <!-- Minutes -->
                    <div class="flex flex-col items-center gap-2 flex-1">
                        <div class="w-full aspect-[4/5] flex items-center justify-center rounded-2xl bg-white dark:bg-zinc-800 shadow-sm ring-1 ring-black/5 dark:ring-white/5 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-transparent to-black/5 dark:to-black/20"></div>
                            <p id="minutes" class="text-slate-900 dark:text-primary text-5xl sm:text-6xl font-black leading-none tracking-tighter relative z-10 tabular-nums">00</p>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider">Min</p>
                    </div>
                    <!-- Separator -->
                    <div class="flex flex-col justify-start pt-6 h-full">
                        <span id="sep2" class="text-slate-300 dark:text-slate-600 text-4xl font-bold">:</span>
                    </div>
                    <!-- Seconds -->
                    <div class="flex flex-col items-center gap-2 flex-1">
                        <div class="w-full aspect-[4/5] flex items-center justify-center rounded-2xl bg-white dark:bg-zinc-800 shadow-sm ring-1 ring-black/5 dark:ring-white/5 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-transparent to-black/5 dark:to-black/20"></div>
                            <p id="seconds" class="text-slate-900 dark:text-primary text-5xl sm:text-6xl font-black leading-none tracking-tighter relative z-10 tabular-nums">00</p>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider">Seg</p>
                    </div>
                </div>
            </div>

            <!-- Main Action Button -->
            <div class="w-full max-w-sm mt-10">
                <button id="actionBtn" class="relative group w-full cursor-pointer flex items-center justify-center overflow-hidden rounded-xl h-14 bg-primary hover:bg-primary-hover active:scale-[0.98] transition-all duration-200 shadow-lg shadow-primary/30">
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    <span id="actionIcon" class="material-symbols-outlined text-black mr-2 text-[28px]">play_circle</span>
                    <span id="actionText" class="text-black text-lg font-bold tracking-wide z-10">INICIAR TURNO</span>
                </button>

                <!-- Info Card (shown when running) -->
                <div id="runningInfo" class="hidden mt-4 p-4 rounded-xl bg-primary/10 border border-primary/20">
                    <p class="text-center text-sm text-slate-600 dark:text-slate-300">
                        <span class="material-symbols-outlined text-primary text-[16px] align-middle mr-1">info</span>
                        Ao finalizar, você informará quanto ganhou
                    </p>
                </div>
            </div>
        </div>

        <!-- Spacer -->
        <div class="h-2 w-full bg-slate-100 dark:bg-black/20 border-y border-slate-200 dark:border-white/5"></div>

        <!-- History Section -->
        <div class="pb-6">
            <div class="flex items-center justify-between px-4 pt-6 pb-2">
                <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Histórico Recente</h3>
            </div>
            <div id="historyContainer" class="px-4 flex flex-col gap-3 mt-2">
                <!-- History will be loaded dynamically -->
                <div class="text-center py-8 text-slate-400">
                    <span class="material-symbols-outlined text-3xl mb-2">hourglass_empty</span>
                    <p class="text-sm">Carregando histórico...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-30 bg-surface-light dark:bg-background-dark border-t border-slate-200 dark:border-white/5 px-6 pt-3 pb-6">
        <div class="flex justify-between items-end max-w-lg mx-auto">
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/Dashboard/dash.html">
                <span class="material-symbols-outlined text-[26px]">home</span>
                <span class="text-[10px] font-medium">Início</span>
            </a>
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/transacao/transacao.html">
                <span class="material-symbols-outlined text-[26px]">receipt_long</span>
                <span class="text-[10px] font-medium">Extrato</span>
            </a>
            <!-- Central FAB -->
            <div class="relative -top-3">
                <a href="/user/Lancamento/lancamento.html" class="flex items-center justify-center w-14 h-14 rounded-full bg-primary shadow-lg shadow-primary/30 text-background-dark hover:scale-105 active:scale-95 transition-all">
                    <span class="material-symbols-outlined text-[32px]">add</span>
                </a>
            </div>
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/metas/meta.html">
                <span class="material-symbols-outlined text-[26px]">flag</span>
                <span class="text-[10px] font-medium">Metas</span>
            </a>
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/configuracoes/config.html">
                <span class="material-symbols-outlined text-[26px]">settings</span>
                <span class="text-[10px] font-medium">Ajustes</span>
            </a>
        </div>
    </nav>

    <!-- End Session Modal -->
    <div id="endSessionModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex items-center gap-3 mb-6">
                <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary/20 text-primary">
                    <span class="material-symbols-outlined text-2xl">summarize</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Encerrar Turno</h3>
                    <p id="modalDuration" class="text-sm text-slate-500 dark:text-slate-400">Duração: 00:00:00</p>
                </div>
            </div>

            <form id="endSessionForm" class="space-y-4">
                <!-- Earnings Input -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">
                        Quanto você faturou? *
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">R$</span>
                        <input
                            type="text"
                            id="inputEarnings"
                            inputmode="decimal"
                            placeholder="0,00"
                            required
                            class="w-full bg-slate-100 dark:bg-white/5 rounded-xl pl-12 pr-4 py-4 border-none focus:ring-2 focus:ring-primary text-lg font-bold"
                        />
                    </div>
                </div>

                <!-- Rides Input -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">
                        Quantas corridas realizou?
                    </label>
                    <input
                        type="number"
                        id="inputRides"
                        inputmode="numeric"
                        placeholder="0"
                        min="0"
                        class="w-full bg-slate-100 dark:bg-white/5 rounded-xl px-4 py-4 border-none focus:ring-2 focus:ring-primary text-lg font-bold"
                    />
                </div>

                <!-- Expenses Input -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">
                        Gastos (combustível, lanche, etc.)
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">R$</span>
                        <input
                            type="text"
                            id="inputExpenses"
                            inputmode="decimal"
                            placeholder="0,00"
                            class="w-full bg-slate-100 dark:bg-white/5 rounded-xl pl-12 pr-4 py-4 border-none focus:ring-2 focus:ring-primary text-lg font-bold"
                        />
                    </div>
                </div>

                <!-- Auto-register checkbox -->
                <div class="pt-2">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="autoRegister" checked class="mt-1 rounded border-slate-300 text-primary focus:ring-primary">
                        <div>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">Lançar automaticamente</span>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Registra faturamento como receita e gastos como despesa</p>
                        </div>
                    </label>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelEndSession" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-white/10 font-semibold transition-colors hover:bg-slate-200 dark:hover:bg-white/20">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-primary text-background-dark font-bold shadow-lg shadow-primary/20 hover:bg-primary-hover transition-colors">
                        Finalizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Modal (Success) -->
    <div id="summaryModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <!-- Success Icon -->
            <div class="flex justify-center mb-4">
                <div class="flex h-16 w-16 items-center justify-center rounded-full bg-green-500/20 text-green-500">
                    <span class="material-symbols-outlined text-4xl" style="font-variation-settings: 'FILL' 1;">check_circle</span>
                </div>
            </div>

            <h3 id="summaryTitle" class="text-xl font-bold text-center text-slate-900 dark:text-white mb-2">Turno Finalizado!</h3>
            <p class="text-center text-slate-500 dark:text-slate-400 text-sm mb-6">Confira o resumo do seu turno</p>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Duration -->
                <div class="bg-slate-100 dark:bg-white/5 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-slate-400 text-xl mb-1">schedule</span>
                    <p id="summaryDuration" class="text-lg font-bold text-slate-900 dark:text-white">0h 0m</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Duração</p>
                </div>
                <!-- Rides -->
                <div class="bg-slate-100 dark:bg-white/5 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-blue-500 text-xl mb-1">directions_car</span>
                    <p id="summaryRides" class="text-lg font-bold text-slate-900 dark:text-white">0</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Corridas</p>
                </div>
                <!-- Hourly Rate -->
                <div class="bg-primary/10 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-primary text-xl mb-1">trending_up</span>
                    <p id="summaryHourly" class="text-lg font-bold text-primary">R$ 0/h</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Por Hora</p>
                </div>
                <!-- Per Ride -->
                <div class="bg-blue-500/10 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-blue-500 text-xl mb-1">local_taxi</span>
                    <p id="summaryPerRide" class="text-lg font-bold text-blue-500">R$ 0</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Por Corrida</p>
                </div>
            </div>

            <!-- Net Profit -->
            <div id="summaryProfitContainer" class="bg-green-500/10 border border-green-500/20 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-green-600 dark:text-green-400 font-medium uppercase tracking-wide">Lucro Líquido</p>
                        <p id="summaryProfit" class="text-2xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                    </div>
                    <span class="material-symbols-outlined text-green-500 text-3xl">savings</span>
                </div>
            </div>

            <!-- Expenses Info (if any) -->
            <div id="summaryExpensesInfo" class="hidden bg-red-500/10 border border-red-500/20 rounded-xl p-3 mb-6">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500 text-lg">remove_circle</span>
                    <span class="text-sm text-red-600 dark:text-red-400">Despesas: <strong id="summaryExpenses">R$ 0,00</strong></span>
                </div>
            </div>

            <!-- Close Button -->
            <button id="closeSummary" class="w-full py-3 rounded-xl bg-primary text-background-dark font-bold shadow-lg shadow-primary/20 hover:bg-primary-hover transition-colors">
                Entendido
            </button>
        </div>
    </div>

    <!-- History Details Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary/20 text-primary">
                        <span class="material-symbols-outlined text-2xl">history</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Detalhes do Turno</h3>
                        <p id="historyModalDate" class="text-sm text-slate-500 dark:text-slate-400">Data</p>
                    </div>
                </div>
                <button id="closeHistoryModal" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-slate-400">close</span>
                </button>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <!-- Duration -->
                <div class="bg-slate-100 dark:bg-white/5 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-slate-400 text-xl mb-1">schedule</span>
                    <p id="historyModalDuration" class="text-lg font-bold text-slate-900 dark:text-white">0h 0m</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Duração</p>
                </div>
                <!-- Rides -->
                <div class="bg-slate-100 dark:bg-white/5 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-blue-500 text-xl mb-1">directions_car</span>
                    <p id="historyModalRides" class="text-lg font-bold text-slate-900 dark:text-white">0</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Corridas</p>
                </div>
                <!-- Hourly Rate -->
                <div class="bg-primary/10 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-primary text-xl mb-1">trending_up</span>
                    <p id="historyModalHourly" class="text-lg font-bold text-primary">R$ 0/h</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Por Hora</p>
                </div>
                <!-- Per Ride -->
                <div class="bg-blue-500/10 rounded-xl p-4 text-center">
                    <span class="material-symbols-outlined text-blue-500 text-xl mb-1">local_taxi</span>
                    <p id="historyModalPerRide" class="text-lg font-bold text-blue-500">R$ 0</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Por Corrida</p>
                </div>
            </div>

            <!-- Earnings -->
            <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4 mb-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-green-600 dark:text-green-400 font-medium uppercase tracking-wide">Faturamento</p>
                        <p id="historyModalEarnings" class="text-2xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                    </div>
                    <span class="material-symbols-outlined text-green-500 text-3xl">payments</span>
                </div>
            </div>

            <!-- Expenses (if any) -->
            <div id="historyModalExpensesContainer" class="hidden bg-red-500/10 border border-red-500/20 rounded-xl p-4 mb-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-red-600 dark:text-red-400 font-medium uppercase tracking-wide">Despesas</p>
                        <p id="historyModalExpenses" class="text-xl font-bold text-red-600 dark:text-red-400">R$ 0,00</p>
                    </div>
                    <span class="material-symbols-outlined text-red-500 text-2xl">remove_circle</span>
                </div>
            </div>

            <!-- Net Profit -->
            <div class="bg-primary/10 border border-primary/20 rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-primary font-medium uppercase tracking-wide">Lucro Líquido</p>
                        <p id="historyModalProfit" class="text-2xl font-bold text-primary">R$ 0,00</p>
                    </div>
                    <span class="material-symbols-outlined text-primary text-3xl">savings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- JavaScript -->
    <script type="module">
        import { requireAuth } from '/js/firebase-config.js';
        import { startSession, endSession, getSessions, getActiveSession, getSession, addTransaction, updateGoalsProgress, cleanupAbandonedSessions } from '/js/db.js';
        import { formatCurrency, formatDuration, formatDurationHuman, formatRelativeDate, formatDate, showToast, saveLocal, getLocal } from '/js/utils.js';

        // Require authentication
        const user = await requireAuth();
        if (!user) throw new Error('Not authenticated');

        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const statusLabel = document.getElementById('statusLabel');
        const statusText = document.getElementById('statusText');
        const currentDateEl = document.getElementById('currentDate');
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        const sep1 = document.getElementById('sep1');
        const sep2 = document.getElementById('sep2');
        const actionBtn = document.getElementById('actionBtn');
        const actionIcon = document.getElementById('actionIcon');
        const actionText = document.getElementById('actionText');
        const runningInfo = document.getElementById('runningInfo');
        const historyContainer = document.getElementById('historyContainer');

        // Modal Elements
        const endSessionModal = document.getElementById('endSessionModal');
        const endSessionForm = document.getElementById('endSessionForm');
        const modalDuration = document.getElementById('modalDuration');
        const inputEarnings = document.getElementById('inputEarnings');
        const inputRides = document.getElementById('inputRides');
        const inputExpenses = document.getElementById('inputExpenses');
        const autoRegister = document.getElementById('autoRegister');
        const cancelEndSession = document.getElementById('cancelEndSession');

        // Summary Modal Elements
        const summaryModal = document.getElementById('summaryModal');
        const summaryTitle = document.getElementById('summaryTitle');
        const summaryDuration = document.getElementById('summaryDuration');
        const summaryRides = document.getElementById('summaryRides');
        const summaryHourly = document.getElementById('summaryHourly');
        const summaryPerRide = document.getElementById('summaryPerRide');
        const summaryProfit = document.getElementById('summaryProfit');
        const summaryProfitContainer = document.getElementById('summaryProfitContainer');
        const summaryExpensesInfo = document.getElementById('summaryExpensesInfo');
        const summaryExpenses = document.getElementById('summaryExpenses');
        const closeSummary = document.getElementById('closeSummary');

        // History Modal Elements
        const historyModal = document.getElementById('historyModal');
        const historyModalDate = document.getElementById('historyModalDate');
        const historyModalDuration = document.getElementById('historyModalDuration');
        const historyModalRides = document.getElementById('historyModalRides');
        const historyModalHourly = document.getElementById('historyModalHourly');
        const historyModalPerRide = document.getElementById('historyModalPerRide');
        const historyModalEarnings = document.getElementById('historyModalEarnings');
        const historyModalExpenses = document.getElementById('historyModalExpenses');
        const historyModalExpensesContainer = document.getElementById('historyModalExpensesContainer');
        const historyModalProfit = document.getElementById('historyModalProfit');
        const closeHistoryModal = document.getElementById('closeHistoryModal');

        // State
        let isRunning = false;
        let currentSessionId = null;
        let sessionStartTime = null; // Firebase startTime as Date
        let timerInterval = null;

        // Format current date
        const today = new Date();
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
        currentDateEl.textContent = today.toLocaleDateString('pt-BR', dateOptions);

        /**
         * Calculate elapsed seconds from Firebase startTime
         * This is the KEY fix - always calculate from the original startTime
         */
        const calculateElapsedSeconds = () => {
            if (!sessionStartTime) return 0;
            return Math.floor((Date.now() - sessionStartTime.getTime()) / 1000);
        };

        // Update timer display based on calculated seconds
        const updateTimerDisplay = () => {
            const elapsedSeconds = calculateElapsedSeconds();
            const hours = Math.floor(elapsedSeconds / 3600);
            const minutes = Math.floor((elapsedSeconds % 3600) / 60);
            const seconds = elapsedSeconds % 60;

            hoursEl.textContent = String(hours).padStart(2, '0');
            minutesEl.textContent = String(minutes).padStart(2, '0');
            secondsEl.textContent = String(seconds).padStart(2, '0');
        };

        // Format duration for display
        const formatDurationDisplay = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        /**
         * Calculate hourly rate with safety checks
         * Prevents absurd values for very short sessions
         */
        const calculateHourlyRate = (earnings, durationSeconds) => {
            if (!earnings || earnings <= 0) return 0;
            if (!durationSeconds || durationSeconds <= 0) return 0;

            const hoursWorked = durationSeconds / 3600;

            // Minimum 5 minutes (0.0833 hours) to avoid crazy high rates
            if (hoursWorked < 0.0833) {
                // For very short sessions, just return the earnings as "rate"
                return earnings;
            }

            return earnings / hoursWorked;
        };

        /**
         * Calculate per-ride rate with safety checks
         */
        const calculatePerRideRate = (earnings, rides) => {
            if (!earnings || earnings <= 0) return 0;
            if (!rides || rides <= 0) return 0;
            return earnings / rides;
        };

        // Start timer interval (only updates display, doesn't increment)
        const startTimerInterval = () => {
            // Clear any existing interval
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Update every second - calculates from startTime each time
            timerInterval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);

            // Animate separators
            sep1.classList.add('animate-pulse');
            sep2.classList.add('animate-pulse');
        };

        // Stop timer interval
        const stopTimerInterval = () => {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            sep1.classList.remove('animate-pulse');
            sep2.classList.remove('animate-pulse');
        };

        // Update UI for running state
        const setRunningState = (running) => {
            isRunning = running;

            if (running) {
                statusDot.classList.remove('bg-slate-400');
                statusDot.classList.add('bg-primary', 'animate-pulse');
                statusLabel.textContent = 'Em andamento';
                statusText.textContent = 'Turno em andamento';
                actionIcon.textContent = 'stop_circle';
                actionText.textContent = 'FINALIZAR TURNO';
                actionBtn.classList.remove('bg-primary', 'hover:bg-primary-hover', 'shadow-primary/30');
                actionBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'shadow-red-500/30');
                runningInfo.classList.remove('hidden');
            } else {
                statusDot.classList.remove('bg-primary', 'animate-pulse');
                statusDot.classList.add('bg-slate-400');
                statusLabel.textContent = 'Status Atual';
                statusText.textContent = 'Você está offline';
                actionIcon.textContent = 'play_circle';
                actionText.textContent = 'INICIAR TURNO';
                actionBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'shadow-red-500/30');
                actionBtn.classList.add('bg-primary', 'hover:bg-primary-hover', 'shadow-primary/30');
                runningInfo.classList.add('hidden');
            }
        };

        // Format currency input
        const formatCurrencyInput = (input) => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length === 0) {
                    e.target.value = '';
                    return;
                }
                const numValue = parseInt(value) / 100;
                e.target.value = numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            });
        };

        formatCurrencyInput(inputEarnings);
        formatCurrencyInput(inputExpenses);

        // Parse currency value
        const parseCurrencyValue = (str) => {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        };

        // Handle action button click
        actionBtn.addEventListener('click', async () => {
            if (isRunning) {
                // Show end session modal
                const elapsed = calculateElapsedSeconds();
                modalDuration.textContent = `Duração: ${formatDurationDisplay(elapsed)}`;
                inputEarnings.value = '';
                inputRides.value = '';
                inputExpenses.value = '';
                endSessionModal.classList.remove('hidden');
                endSessionModal.classList.add('flex');
                inputEarnings.focus();
            } else {
                // Start session
                try {
                    actionBtn.disabled = true;
                    actionText.textContent = 'INICIANDO...';

                    // startSession now returns existing session if one exists (Singleton)
                    currentSessionId = await startSession();

                    // Fetch the session to get the actual startTime from Firebase
                    const session = await getSession(currentSessionId);
                    if (session && session.startTime) {
                        sessionStartTime = session.startTime;
                    } else {
                        sessionStartTime = new Date();
                    }

                    setRunningState(true);
                    updateTimerDisplay();
                    startTimerInterval();
                    showToast('Turno iniciado! Bom trabalho!', 'success');

                } catch (error) {
                    console.error('Erro ao iniciar sessão:', error);
                    showToast('Erro ao iniciar turno', 'error');
                } finally {
                    actionBtn.disabled = false;
                }
            }
        });

        // Cancel end session modal
        cancelEndSession.addEventListener('click', () => {
            endSessionModal.classList.add('hidden');
            endSessionModal.classList.remove('flex');
        });

        endSessionModal.addEventListener('click', (e) => {
            if (e.target === endSessionModal) {
                endSessionModal.classList.add('hidden');
                endSessionModal.classList.remove('flex');
            }
        });

        // Handle end session form submit
        endSessionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const earnings = parseCurrencyValue(inputEarnings.value);
            const rides = parseInt(inputRides.value) || 0;
            const expenses = parseCurrencyValue(inputExpenses.value);

            if (earnings <= 0) {
                showToast('Informe o valor faturado', 'error');
                inputEarnings.focus();
                return;
            }

            // Get final elapsed time
            const finalElapsedSeconds = calculateElapsedSeconds();

            // Stop timer
            stopTimerInterval();

            // Hide modal
            endSessionModal.classList.add('hidden');
            endSessionModal.classList.remove('flex');

            try {
                // Save session with new data
                await endSession(currentSessionId, finalElapsedSeconds, earnings, rides, expenses);

                // Auto-register transactions if checked
                if (autoRegister.checked) {
                    // Register earnings as income
                    if (earnings > 0) {
                        await addTransaction({
                            type: 'income',
                            amount: earnings,
                            category: 'uber',
                            date: new Date(),
                            description: `Turno de ${formatDurationHuman(finalElapsedSeconds)}`
                        });
                        await updateGoalsProgress(earnings, 'receita');
                    }

                    // Register expenses
                    if (expenses > 0) {
                        await addTransaction({
                            type: 'expense',
                            amount: expenses,
                            category: 'combustivel',
                            date: new Date(),
                            description: 'Gastos do turno'
                        });
                    }

                    // Register rides
                    if (rides > 0) {
                        await addTransaction({
                            type: 'corridas',
                            amount: rides,
                            category: 'corridas',
                            date: new Date(),
                            description: `Corridas do turno`
                        });
                        await updateGoalsProgress(rides, 'corridas');
                    }
                }

                // Calculate summary stats with safety checks
                const hourlyRate = calculateHourlyRate(earnings, finalElapsedSeconds);
                const perRide = calculatePerRideRate(earnings, rides);
                const netProfit = earnings - expenses;

                // Update summary modal
                const durationHours = Math.floor(finalElapsedSeconds / 3600);
                const durationMins = Math.floor((finalElapsedSeconds % 3600) / 60);
                summaryDuration.textContent = `${durationHours}h ${durationMins}m`;
                summaryRides.textContent = rides.toString();
                summaryHourly.textContent = formatCurrency(hourlyRate) + '/h';
                summaryPerRide.textContent = rides > 0 ? formatCurrency(perRide) : '-';
                summaryProfit.textContent = formatCurrency(netProfit);

                // Show expenses if any
                if (expenses > 0) {
                    summaryExpensesInfo.classList.remove('hidden');
                    summaryExpenses.textContent = formatCurrency(expenses);
                } else {
                    summaryExpensesInfo.classList.add('hidden');
                }

                // Show summary modal
                summaryModal.classList.remove('hidden');
                summaryModal.classList.add('flex');

                // Reset state
                currentSessionId = null;
                sessionStartTime = null;
                hoursEl.textContent = '00';
                minutesEl.textContent = '00';
                secondsEl.textContent = '00';
                setRunningState(false);

                // Reload history
                await loadHistory();

            } catch (error) {
                console.error('Erro ao finalizar sessão:', error);
                showToast('Erro ao finalizar turno', 'error');
                // Restart timer if error
                startTimerInterval();
            }
        });

        // Close summary modal
        closeSummary.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
            summaryModal.classList.remove('flex');
        });

        summaryModal.addEventListener('click', (e) => {
            if (e.target === summaryModal) {
                summaryModal.classList.add('hidden');
                summaryModal.classList.remove('flex');
            }
        });

        // Close history modal
        closeHistoryModal.addEventListener('click', () => {
            historyModal.classList.add('hidden');
            historyModal.classList.remove('flex');
        });

        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.add('hidden');
                historyModal.classList.remove('flex');
            }
        });

        // Show history details modal
        const showHistoryDetails = (session) => {
            const dateStr = session.startTime.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const duration = session.duration || 0;
            const earnings = session.earnings || 0;
            const rides = session.rides || 0;
            const expenses = session.expenses || 0;
            const netProfit = earnings - expenses;

            const hourlyRate = calculateHourlyRate(earnings, duration);
            const perRide = calculatePerRideRate(earnings, rides);

            const durationHours = Math.floor(duration / 3600);
            const durationMins = Math.floor((duration % 3600) / 60);

            historyModalDate.textContent = dateStr;
            historyModalDuration.textContent = `${durationHours}h ${durationMins}m`;
            historyModalRides.textContent = rides.toString();
            historyModalHourly.textContent = formatCurrency(hourlyRate) + '/h';
            historyModalPerRide.textContent = rides > 0 ? formatCurrency(perRide) : '-';
            historyModalEarnings.textContent = formatCurrency(earnings);
            historyModalProfit.textContent = formatCurrency(netProfit);

            if (expenses > 0) {
                historyModalExpensesContainer.classList.remove('hidden');
                historyModalExpenses.textContent = formatCurrency(expenses);
            } else {
                historyModalExpensesContainer.classList.add('hidden');
            }

            historyModal.classList.remove('hidden');
            historyModal.classList.add('flex');
        };

        // Load history
        const loadHistory = async () => {
            try {
                const sessions = await getSessions({ limit: 10 });

                // Filter only completed sessions
                const completedSessions = sessions.filter(s => s.status === 'completed');

                if (!completedSessions || completedSessions.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <span class="material-symbols-outlined text-3xl mb-2">work_history</span>
                            <p class="text-sm">Nenhum turno registrado ainda</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                completedSessions.slice(0, 5).forEach((session, index) => {
                    const dateStr = formatRelativeDate(session.startTime);
                    const duration = session.duration || 0;
                    const earnings = session.earnings || 0;
                    const rides = session.rides || 0;
                    const hourlyRate = calculateHourlyRate(earnings, duration);

                    html += `
                        <div class="history-item flex items-center justify-between p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-white/5 shadow-sm cursor-pointer hover:border-primary/30 hover:shadow-md transition-all"
                             data-session-index="${index}">
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-full bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-500 dark:text-slate-400">
                                    <span class="material-symbols-outlined text-xl">calendar_today</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-slate-900 dark:text-white font-bold text-sm">${dateStr}</span>
                                    <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                                        <span>${formatDurationHuman(duration)}</span>
                                        ${rides ? `<span>• ${rides} corrida${rides > 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex flex-col items-end gap-0.5">
                                    <span class="text-primary font-bold text-sm">+ ${formatCurrency(earnings)}</span>
                                    <span class="text-xs text-slate-500 dark:text-slate-400">${formatCurrency(hourlyRate)}/h</span>
                                </div>
                                <span class="material-symbols-outlined text-slate-300 dark:text-slate-600 text-lg">chevron_right</span>
                            </div>
                        </div>
                    `;
                });

                historyContainer.innerHTML = html;

                // Add click handlers to history items
                document.querySelectorAll('.history-item').forEach((item) => {
                    item.addEventListener('click', () => {
                        const index = parseInt(item.dataset.sessionIndex);
                        const session = completedSessions[index];
                        if (session) {
                            showHistoryDetails(session);
                        }
                    });
                });

            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <span class="material-symbols-outlined text-3xl mb-2">error_outline</span>
                        <p class="text-sm">Erro ao carregar histórico</p>
                        <button onclick="location.reload()" class="mt-2 text-primary text-sm font-semibold">Tentar novamente</button>
                    </div>
                `;
            }
        };

        // Check for active session and resume timer
        const checkActiveSession = async () => {
            try {
                // First cleanup any abandoned sessions (older than 24h)
                await cleanupAbandonedSessions();

                // Check Firebase for active session
                const activeSession = await getActiveSession();

                if (activeSession) {
                    console.log('Sessão ativa encontrada:', activeSession.id);
                    currentSessionId = activeSession.id;
                    sessionStartTime = activeSession.startTime;

                    // Calculate current elapsed time
                    const elapsed = calculateElapsedSeconds();
                    console.log('Tempo decorrido:', formatDurationDisplay(elapsed));

                    setRunningState(true);
                    updateTimerDisplay();
                    startTimerInterval();
                } else {
                    console.log('Nenhuma sessão ativa');
                    setRunningState(false);
                }
            } catch (error) {
                console.error('Erro ao verificar sessão ativa:', error);
                // Continue anyway
            }
        };

        // Initialize
        const init = async () => {
            try {
                await checkActiveSession();
            } catch (error) {
                console.error('Erro ao verificar sessão:', error);
            }

            await loadHistory();
        };

        init().catch(error => {
            console.error('Erro na inicialização:', error);
        });
    </script>
</body>
</html>
