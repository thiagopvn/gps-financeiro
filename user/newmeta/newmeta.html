<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Nova Meta - GPS Financeiro</title>
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png"/>
    <!-- Resource Hints -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <!-- Theme Persistence -->
    <script src="/shared/theme.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/shared/styles.css"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/shared/tailwind-config.js"></script>
    <style>
        .type-card.selected {
            border-color: var(--selected-color, #22c55e);
            background-color: var(--selected-bg, rgba(34, 197, 94, 0.1));
        }
        .type-card.selected .check-icon {
            display: flex;
        }
        .type-card .check-icon {
            display: none;
        }
        .period-chip.selected {
            background-color: #FFD700;
            color: #000000;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display flex flex-col h-screen overflow-hidden antialiased">
    <!-- Header -->
    <header class="flex-none px-4 pt-12 pb-4 bg-background-light dark:bg-background-dark z-20">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button id="backBtn" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-slate-500">arrow_back</span>
                </button>
                <h1 class="text-xl font-bold tracking-tight">Nova Meta</h1>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar pb-40 px-4">
        <!-- Title & Description -->
        <section class="space-y-4 mb-6">
            <div class="bg-white dark:bg-surface-dark rounded-2xl overflow-hidden border border-gray-200 dark:border-white/5">
                <div class="relative px-4 py-3">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1" for="goalName">
                        Nome da Meta *
                    </label>
                    <input
                        id="goalName"
                        type="text"
                        placeholder="Ex: Meta diária de faturamento"
                        class="w-full bg-transparent border-0 text-slate-900 dark:text-white text-base font-medium placeholder-slate-400 focus:ring-0 p-0"
                    />
                </div>
                <div class="h-px bg-gray-200 dark:bg-white/10 mx-4"></div>
                <div class="relative px-4 py-3">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1" for="goalDescription">
                        Descrição (opcional)
                    </label>
                    <input
                        id="goalDescription"
                        type="text"
                        placeholder="Adicione detalhes sobre sua meta"
                        class="w-full bg-transparent border-0 text-slate-900 dark:text-white text-sm placeholder-slate-400 focus:ring-0 p-0"
                    />
                </div>
            </div>
        </section>

        <!-- Category Selection -->
        <section class="mb-6">
            <h2 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-3 ml-1">Categoria</h2>
            <div class="grid grid-cols-2 gap-3">
                <!-- Receita -->
                <label class="type-card selected cursor-pointer relative flex items-center gap-3 rounded-xl p-4 bg-white dark:bg-surface-dark border-2 border-green-500 transition-all" style="--selected-color: #22c55e; --selected-bg: rgba(34, 197, 94, 0.1);">
                    <input checked class="sr-only" name="goal_category" type="radio" value="receita"/>
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-green-500/20 text-green-500">
                        <span class="material-symbols-outlined">trending_up</span>
                    </div>
                    <div class="flex-1">
                        <span class="block font-semibold text-sm">Receita</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400">Faturamento</span>
                    </div>
                    <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-green-500 items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">check</span>
                    </div>
                </label>
                <!-- Economia -->
                <label class="type-card cursor-pointer relative flex items-center gap-3 rounded-xl p-4 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-yellow-400/50 transition-all" style="--selected-color: #facc15; --selected-bg: rgba(250, 204, 21, 0.1);">
                    <input class="sr-only" name="goal_category" type="radio" value="economia"/>
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-yellow-400/20 text-yellow-500">
                        <span class="material-symbols-outlined">savings</span>
                    </div>
                    <div class="flex-1">
                        <span class="block font-semibold text-sm">Economia</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400">Guardar dinheiro</span>
                    </div>
                    <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-yellow-400 items-center justify-center">
                        <span class="material-symbols-outlined text-background-dark text-sm">check</span>
                    </div>
                </label>
                <!-- Corridas -->
                <label class="type-card cursor-pointer relative flex items-center gap-3 rounded-xl p-4 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-blue-400/50 transition-all" style="--selected-color: #3b82f6; --selected-bg: rgba(59, 130, 246, 0.1);">
                    <input class="sr-only" name="goal_category" type="radio" value="corridas"/>
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-blue-500/20 text-blue-500">
                        <span class="material-symbols-outlined">directions_car</span>
                    </div>
                    <div class="flex-1">
                        <span class="block font-semibold text-sm">Corridas</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400">Qtd. de viagens</span>
                    </div>
                    <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-blue-500 items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">check</span>
                    </div>
                </label>
                <!-- Quilometragem -->
                <label class="type-card cursor-pointer relative flex items-center gap-3 rounded-xl p-4 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-purple-400/50 transition-all" style="--selected-color: #a855f7; --selected-bg: rgba(168, 85, 247, 0.1);">
                    <input class="sr-only" name="goal_category" type="radio" value="km"/>
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-purple-500/20 text-purple-500">
                        <span class="material-symbols-outlined">speed</span>
                    </div>
                    <div class="flex-1">
                        <span class="block font-semibold text-sm">Quilometragem</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400">Distância rodada</span>
                    </div>
                    <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-purple-500 items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">check</span>
                    </div>
                </label>
            </div>
        </section>

        <!-- Target Value -->
        <section class="mb-6">
            <h2 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-3 ml-1">Valor Alvo</h2>
            <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 border border-gray-200 dark:border-white/5">
                <div class="flex flex-col items-center justify-center">
                    <div id="targetPrefix" class="text-slate-400 text-sm font-medium mb-1">R$</div>
                    <input
                        id="targetValue"
                        type="text"
                        inputmode="decimal"
                        placeholder="0,00"
                        class="w-full bg-transparent border-0 text-center text-4xl font-bold text-slate-900 dark:text-white placeholder-slate-600 focus:ring-0 p-0 tracking-tight"
                    />
                    <p id="targetHelper" class="text-xs text-slate-500 dark:text-slate-400 mt-2">Digite o valor que deseja atingir</p>
                </div>
            </div>
        </section>

        <!-- Period Selection -->
        <section class="mb-6">
            <h2 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-3 ml-1">Período de Reset</h2>
            <div class="flex gap-3">
                <button type="button" class="period-chip selected flex-1 py-3 rounded-xl bg-primary text-background-dark font-bold text-sm transition-all" data-period="daily">
                    Diária
                </button>
                <button type="button" class="period-chip flex-1 py-3 rounded-xl bg-white dark:bg-surface-dark border border-gray-200 dark:border-white/10 text-slate-600 dark:text-slate-300 font-medium text-sm transition-all hover:border-primary/50" data-period="weekly">
                    Semanal
                </button>
                <button type="button" class="period-chip flex-1 py-3 rounded-xl bg-white dark:bg-surface-dark border border-gray-200 dark:border-white/10 text-slate-600 dark:text-slate-300 font-medium text-sm transition-all hover:border-primary/50" data-period="monthly">
                    Mensal
                </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2 ml-1">
                <span class="material-symbols-outlined text-sm align-middle mr-1">info</span>
                <span id="periodInfo">A meta será resetada todo dia à meia-noite</span>
            </p>
        </section>

        <!-- Retroactivity Option (for weekly/monthly) -->
        <section id="retroactivitySection" class="mb-6 hidden">
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="retroactiveCheckbox" class="mt-1 rounded border-slate-300 text-primary focus:ring-primary">
                    <div>
                        <span class="text-sm font-medium text-slate-900 dark:text-white">Considerar lançamentos anteriores</span>
                        <p id="retroactiveInfo" class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                            O progresso atual será calculado com base nos lançamentos já feitos neste período
                        </p>
                    </div>
                </label>
            </div>
        </section>
    </main>

    <!-- Fixed Save Button -->
    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto px-4 pt-6 pb-safe bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 dark:to-transparent z-30">
        <div class="pb-4">
            <button id="saveBtn" class="w-full rounded-xl bg-primary py-4 text-center text-base font-bold text-black shadow-lg shadow-primary/30 hover:bg-primary-hover transition-colors active:scale-[0.98] flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check</span>
                Criar Meta
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- JavaScript -->
    <script type="module">
        import { requireAuth } from '/js/firebase-config.js';
        import { addGoal, getTransactions, updateGoal } from '/js/db.js';
        import { showToast, formatCurrency, parseCurrency, getStartOfWeek, getStartOfMonth } from '/js/utils.js';

        // Wait for auth - must complete before proceeding
        const user = await requireAuth();
        if (!user) {
            console.error('Usuário não autenticado');
            throw new Error('Not authenticated');
        }

        // Category to color mapping (automatic)
        const categoryColors = {
            receita: 'green',
            economia: 'yellow',
            corridas: 'blue',
            km: 'purple'
        };

        // State
        let selectedCategory = 'receita';
        let selectedPeriod = 'daily';

        // DOM Elements
        const backBtn = document.getElementById('backBtn');
        const goalName = document.getElementById('goalName');
        const goalDescription = document.getElementById('goalDescription');
        const targetValue = document.getElementById('targetValue');
        const targetPrefix = document.getElementById('targetPrefix');
        const targetHelper = document.getElementById('targetHelper');
        const periodInfo = document.getElementById('periodInfo');
        const saveBtn = document.getElementById('saveBtn');
        const categoryCards = document.querySelectorAll('.type-card');
        const periodChips = document.querySelectorAll('.period-chip');
        const retroactivitySection = document.getElementById('retroactivitySection');
        const retroactiveCheckbox = document.getElementById('retroactiveCheckbox');
        const retroactiveInfo = document.getElementById('retroactiveInfo');

        // Category selection - use click on card for better reliability
        categoryCards.forEach(card => {
            card.addEventListener('click', () => {
                const input = card.querySelector('input');
                input.checked = true;
                categoryCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedCategory = input.value;
                updateTargetPrefix();
                updateRetroactivityInfo();
            });
        });

        // Update target prefix based on category
        function updateTargetPrefix() {
            if (selectedCategory === 'receita' || selectedCategory === 'economia') {
                targetPrefix.textContent = 'R$';
                targetHelper.textContent = 'Digite o valor que deseja atingir';
            } else if (selectedCategory === 'corridas') {
                targetPrefix.textContent = 'Corridas';
                targetHelper.textContent = 'Número de corridas para completar';
            } else if (selectedCategory === 'km') {
                targetPrefix.textContent = 'KM';
                targetHelper.textContent = 'Quilômetros a percorrer';
            }
        }

        // Period selection
        periodChips.forEach(chip => {
            chip.addEventListener('click', () => {
                periodChips.forEach(c => {
                    c.classList.remove('selected');
                    c.classList.add('bg-white', 'dark:bg-surface-dark', 'border', 'border-gray-200', 'dark:border-white/10', 'text-slate-600', 'dark:text-slate-300', 'font-medium');
                    c.classList.remove('bg-primary', 'text-background-dark', 'font-bold');
                });
                chip.classList.add('selected');
                chip.classList.remove('bg-white', 'dark:bg-surface-dark', 'border', 'border-gray-200', 'dark:border-white/10', 'text-slate-600', 'dark:text-slate-300', 'font-medium');
                chip.classList.add('bg-primary', 'text-background-dark', 'font-bold');
                selectedPeriod = chip.dataset.period;
                updatePeriodInfo();
                updateRetroactivityVisibility();
            });
        });

        // Update period info text
        function updatePeriodInfo() {
            switch (selectedPeriod) {
                case 'daily':
                    periodInfo.textContent = 'A meta será resetada todo dia à meia-noite';
                    break;
                case 'weekly':
                    periodInfo.textContent = 'A meta será resetada toda segunda-feira';
                    break;
                case 'monthly':
                    periodInfo.textContent = 'A meta será resetada no primeiro dia de cada mês';
                    break;
            }
        }

        // Show/hide retroactivity section based on period
        function updateRetroactivityVisibility() {
            if (selectedPeriod === 'weekly' || selectedPeriod === 'monthly') {
                retroactivitySection.classList.remove('hidden');
            } else {
                retroactivitySection.classList.add('hidden');
                retroactiveCheckbox.checked = false;
            }
        }

        // Update retroactivity info text
        function updateRetroactivityInfo() {
            const categoryLabel = {
                receita: 'receitas',
                economia: 'economias',
                corridas: 'corridas',
                km: 'quilômetros'
            };
            retroactiveInfo.textContent = `O progresso será calculado somando ${categoryLabel[selectedCategory] || 'lançamentos'} deste período`;
        }

        // Format target value input
        targetValue.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length === 0) {
                e.target.value = '';
                return;
            }

            // For currency values
            if (selectedCategory === 'receita' || selectedCategory === 'economia') {
                const numValue = parseInt(value) / 100;
                e.target.value = numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                // For numeric values (corridas, km)
                e.target.value = parseInt(value).toLocaleString('pt-BR');
            }
        });

        // Parse target value
        function parseTargetValue() {
            const value = targetValue.value.replace(/\./g, '').replace(',', '.');
            return parseFloat(value) || 0;
        }

        // Calculate initial value from past transactions (retroactivity)
        async function calculateRetroactiveValue() {
            let startDate;
            if (selectedPeriod === 'weekly') {
                startDate = getStartOfWeek();
            } else if (selectedPeriod === 'monthly') {
                startDate = getStartOfMonth();
            } else {
                return 0;
            }

            try {
                const transactions = await getTransactions({ startDate });
                let total = 0;

                transactions.forEach(t => {
                    // Match category to transaction type
                    if (selectedCategory === 'receita' && t.type === 'income') {
                        total += t.amount || 0;
                    } else if (selectedCategory === 'economia' && t.type === 'expense' && t.subType === 'saving') {
                        // Economia são despesas com subType 'saving'
                        total += t.amount || 0;
                    } else if (selectedCategory === 'corridas' && t.type === 'corridas') {
                        total += t.amount || 0;
                    } else if (selectedCategory === 'km' && t.type === 'km') {
                        total += t.amount || 0;
                    }
                });

                return total;
            } catch (error) {
                console.error('Error calculating retroactive value:', error);
                return 0;
            }
        }

        // Save goal
        saveBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // Validate
            const name = goalName.value.trim();
            if (!name) {
                showToast('Digite um nome para a meta', 'error');
                goalName.focus();
                return;
            }

            const target = parseTargetValue();
            console.log('Target value parsed:', target);

            if (target <= 0 || isNaN(target)) {
                showToast('Digite um valor alvo válido', 'error');
                targetValue.focus();
                return;
            }

            // Disable button
            saveBtn.disabled = true;
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Salvando...';

            try {
                // Get automatic color based on category
                const autoColor = categoryColors[selectedCategory] || 'green';

                const goalData = {
                    name: name,
                    description: goalDescription.value.trim() || null,
                    category: selectedCategory,
                    type: selectedPeriod,
                    target: target,
                    color: autoColor
                };

                console.log('Saving goal:', goalData);

                const goalId = await addGoal(goalData);
                console.log('Goal created with ID:', goalId);

                // Calculate and set retroactive value if checkbox is checked
                if (retroactiveCheckbox.checked && (selectedPeriod === 'weekly' || selectedPeriod === 'monthly')) {
                    const retroactiveValue = await calculateRetroactiveValue();
                    if (retroactiveValue > 0) {
                        await updateGoal(goalId, { current: retroactiveValue });
                        console.log('Retroactive value set:', retroactiveValue);
                    }
                }

                showToast('Meta criada com sucesso!', 'success');

                // Redirect to goals page
                setTimeout(() => {
                    window.location.href = '/user/metas/meta.html';
                }, 1000);

            } catch (error) {
                console.error('Error creating goal:', error);
                showToast('Erro ao criar meta. Tente novamente.', 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            }
        });

        // Navigation
        backBtn.addEventListener('click', () => window.history.back());

        // Initialize
        updateTargetPrefix();
        updatePeriodInfo();
        updateRetroactivityVisibility();
        updateRetroactivityInfo();
    </script>
</body>
</html>
