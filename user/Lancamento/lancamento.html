<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Novo Lançamento - GPS Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                        "surface-dark": "#1a2c20",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "1.5rem",
                        "xl": "2rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        html, body {
            min-height: 100dvh;
            overflow-x: hidden;
        }
        .category-item:not(.selected) .check-icon {
            display: none;
        }
        .category-item.selected {
            border-color: var(--tw-border-opacity, 1) !important;
        }
        .type-tab.active {
            background-color: var(--active-bg, #13ec5b);
            color: var(--active-text, #102216);
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white antialiased">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto shadow-2xl">
        <!-- Header -->
        <header class="flex items-center justify-between px-4 py-4 pt-12 bg-background-light dark:bg-background-dark z-10">
            <button id="backBtn" class="flex size-10 items-center justify-center rounded-full text-slate-500 dark:text-slate-400 hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold tracking-tight text-center flex-1">Novo Lançamento</h2>
            <button id="closeBtn" class="flex size-10 items-center justify-center rounded-full text-slate-500 dark:text-slate-400 hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 28px;">close</span>
            </button>
        </header>

        <!-- Main Content Scrollable Area -->
        <main class="flex-1 pb-32 px-4">
            <!-- Type Toggle - 4 Options -->
            <div class="py-4">
                <div class="grid grid-cols-4 gap-1 h-12 w-full items-center justify-center rounded-xl bg-slate-200 dark:bg-[#1c3628] p-1">
                    <button id="tabReceita" class="type-tab active h-full flex items-center justify-center rounded-lg text-xs font-semibold transition-all" style="--active-bg: #13ec5b; --active-text: #102216;">
                        <span class="material-symbols-outlined text-[16px] mr-1">trending_up</span>
                        Receita
                    </button>
                    <button id="tabDespesa" class="type-tab h-full flex items-center justify-center rounded-lg text-xs font-semibold text-slate-500 dark:text-slate-400 transition-all" style="--active-bg: #ef4444; --active-text: white;">
                        <span class="material-symbols-outlined text-[16px] mr-1">trending_down</span>
                        Despesa
                    </button>
                    <button id="tabCorridas" class="type-tab h-full flex items-center justify-center rounded-lg text-xs font-semibold text-slate-500 dark:text-slate-400 transition-all" style="--active-bg: #3b82f6; --active-text: white;">
                        <span class="material-symbols-outlined text-[16px] mr-1">directions_car</span>
                        Corridas
                    </button>
                    <button id="tabKm" class="type-tab h-full flex items-center justify-center rounded-lg text-xs font-semibold text-slate-500 dark:text-slate-400 transition-all" style="--active-bg: #a855f7; --active-text: white;">
                        <span class="material-symbols-outlined text-[16px] mr-1">speed</span>
                        KM
                    </button>
                </div>
            </div>

            <!-- Amount/Value Input -->
            <div class="flex flex-col items-center justify-center py-6">
                <div id="amountLabel" class="text-slate-400 dark:text-slate-500 text-sm font-medium mb-2">Valor da receita</div>
                <div id="amountPrefix" class="text-slate-400 text-lg font-medium">R$</div>
                <div class="flex items-baseline relative">
                    <input
                        type="text"
                        id="amountInput"
                        inputmode="numeric"
                        class="text-4xl font-bold text-slate-900 dark:text-white tracking-tighter bg-transparent border-none text-center focus:ring-0 focus:outline-none w-full max-w-[250px] p-0"
                        value="0,00"
                        readonly
                    />
                </div>
                <!-- Numeric Keypad -->
                <div class="grid grid-cols-3 gap-3 mt-6 w-full max-w-[280px]">
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="1">1</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="2">2</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="3">3</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="4">4</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="5">5</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="6">6</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="7">7</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="8">8</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="9">9</button>
                    <button id="decimalKey" class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value=",">.</button>
                    <button class="num-key h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors" data-value="0">0</button>
                    <button id="backspaceKey" class="h-14 rounded-xl bg-white dark:bg-surface-dark text-xl font-semibold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors flex items-center justify-center">
                        <span class="material-symbols-outlined">backspace</span>
                    </button>
                </div>
            </div>

            <!-- Categories for Income -->
            <div id="incomeCategories" class="mb-6">
                <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight mb-4">Categoria</h3>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Uber -->
                    <label class="category-item income-cat selected group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-primary shadow-sm transition-all" data-category="uber">
                        <input checked class="peer sr-only" name="income-category" type="radio" value="uber"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-black text-white">
                            <span class="material-symbols-outlined">directions_car</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Uber</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Aplicativo</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-primary" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- 99 -->
                    <label class="category-item income-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="99">
                        <input class="peer sr-only" name="income-category" type="radio" value="99"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-yellow-400 text-black">
                            <span class="material-symbols-outlined">local_taxi</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">99</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Aplicativo</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-primary" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Indrive -->
                    <label class="category-item income-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="indrive">
                        <input class="peer sr-only" name="income-category" type="radio" value="indrive"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-green-500 text-white">
                            <span class="material-symbols-outlined">two_wheeler</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Indrive</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Negociacao</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-primary" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Particular -->
                    <label class="category-item income-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="particular">
                        <input class="peer sr-only" name="income-category" type="radio" value="particular"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-500 text-white">
                            <span class="material-symbols-outlined">person</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Particular</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Corrida extra</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-primary" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Outros -->
                    <label class="category-item income-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="outros_receita">
                        <input class="peer sr-only" name="income-category" type="radio" value="outros_receita"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-purple-500 text-white">
                            <span class="material-symbols-outlined">more_horiz</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Outros</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Outras receitas</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-primary" style="font-size: 20px;">check_circle</span>
                    </label>
                </div>
            </div>

            <!-- Categories for Expense (hidden by default) -->
            <div id="expenseCategories" class="mb-6 hidden">
                <h3 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight mb-4">Categoria</h3>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Combustivel -->
                    <label class="category-item expense-cat selected group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-red-500 shadow-sm transition-all" data-category="combustivel">
                        <input checked class="peer sr-only" name="expense-category" type="radio" value="combustivel"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-orange-500 text-white">
                            <span class="material-symbols-outlined">local_gas_station</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Combustivel</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Gasolina/Etanol</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Manutencao -->
                    <label class="category-item expense-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="manutencao">
                        <input class="peer sr-only" name="expense-category" type="radio" value="manutencao"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-slate-600 text-white">
                            <span class="material-symbols-outlined">build</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Manutencao</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Reparos/Revisao</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Alimentacao -->
                    <label class="category-item expense-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="alimentacao">
                        <input class="peer sr-only" name="expense-category" type="radio" value="alimentacao"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-amber-500 text-white">
                            <span class="material-symbols-outlined">restaurant</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Alimentacao</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Refeicoes</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Lavagem -->
                    <label class="category-item expense-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="lavagem">
                        <input class="peer sr-only" name="expense-category" type="radio" value="lavagem"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-cyan-500 text-white">
                            <span class="material-symbols-outlined">local_car_wash</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Lavagem</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Limpeza veiculo</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Estacionamento -->
                    <label class="category-item expense-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="estacionamento">
                        <input class="peer sr-only" name="expense-category" type="radio" value="estacionamento"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-indigo-500 text-white">
                            <span class="material-symbols-outlined">local_parking</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Estacionamento</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Pedagios/Parking</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                    <!-- Outros -->
                    <label class="category-item expense-cat group cursor-pointer relative flex items-center gap-3 rounded-xl p-3 bg-white dark:bg-surface-dark border-2 border-transparent hover:border-slate-200 dark:hover:border-white/10 transition-all" data-category="outros_despesa">
                        <input class="peer sr-only" name="expense-category" type="radio" value="outros_despesa"/>
                        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-rose-500 text-white">
                            <span class="material-symbols-outlined">more_horiz</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Outros</span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Outras despesas</span>
                        </div>
                        <span class="check-icon material-symbols-outlined absolute right-3 text-red-500" style="font-size: 20px;">check_circle</span>
                    </label>
                </div>
            </div>

            <!-- Info Card for Corridas/KM -->
            <div id="infoCard" class="mb-6 hidden">
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-blue-500 text-xl">info</span>
                        <div>
                            <p id="infoTitle" class="text-sm font-bold text-slate-900 dark:text-white mb-1">Registrar Corridas</p>
                            <p id="infoText" class="text-xs text-slate-500 dark:text-slate-400">Este lancamento sera contabilizado nas suas metas de corridas.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Details Inputs -->
            <div class="space-y-4 mb-6">
                <!-- Date Picker -->
                <div class="flex items-center gap-3 rounded-xl bg-white dark:bg-surface-dark p-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-slate-100 dark:bg-white/5 text-slate-500 dark:text-slate-400">
                        <span class="material-symbols-outlined">calendar_today</span>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Data</label>
                        <input id="dateInput" class="w-full bg-transparent p-0 text-sm font-semibold text-slate-900 dark:text-white focus:ring-0 border-none h-6" type="date"/>
                    </div>
                </div>
                <!-- Notes Input -->
                <div class="flex items-center gap-3 rounded-xl bg-white dark:bg-surface-dark p-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-slate-100 dark:bg-white/5 text-slate-500 dark:text-slate-400">
                        <span class="material-symbols-outlined">description</span>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Descricao (Opcional)</label>
                        <input id="descriptionInput" class="w-full bg-transparent p-0 text-sm text-slate-900 dark:text-white placeholder-slate-400 focus:ring-0 border-none h-6" placeholder="Adicionar nota..." type="text"/>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Action -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 pb-8 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark dark:via-background-dark dark:to-transparent pt-12 z-20">
            <button id="saveBtn" class="w-full rounded-xl bg-primary py-4 text-center text-base font-bold text-slate-900 shadow-lg shadow-primary/20 hover:bg-[#34f574] transition-colors active:scale-[0.98] flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check</span>
                <span id="saveBtnText">Salvar Lancamento</span>
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- JavaScript -->
    <script type="module">
        import { requireAuth } from '/js/firebase-config.js';
        import { addTransaction, updateGoalsProgress } from '/js/db.js';
        import { showToast, formatCurrency, parseCurrency } from '/js/utils.js';

        // Wait for auth - must complete before proceeding
        const user = await requireAuth();
        if (!user) {
            console.error('Usuario nao autenticado');
            throw new Error('Not authenticated');
        }

        console.log('Usuario autenticado:', user.uid);

        // State
        let currentType = 'income'; // income, expense, corridas, km
        let rawValue = '0';
        let isCurrency = true;

        // DOM Elements
        const tabReceita = document.getElementById('tabReceita');
        const tabDespesa = document.getElementById('tabDespesa');
        const tabCorridas = document.getElementById('tabCorridas');
        const tabKm = document.getElementById('tabKm');
        const amountInput = document.getElementById('amountInput');
        const amountLabel = document.getElementById('amountLabel');
        const amountPrefix = document.getElementById('amountPrefix');
        const dateInput = document.getElementById('dateInput');
        const descriptionInput = document.getElementById('descriptionInput');
        const saveBtn = document.getElementById('saveBtn');
        const saveBtnText = document.getElementById('saveBtnText');
        const backBtn = document.getElementById('backBtn');
        const closeBtn = document.getElementById('closeBtn');
        const incomeCategories = document.getElementById('incomeCategories');
        const expenseCategories = document.getElementById('expenseCategories');
        const infoCard = document.getElementById('infoCard');
        const infoTitle = document.getElementById('infoTitle');
        const infoText = document.getElementById('infoText');
        const numKeys = document.querySelectorAll('.num-key');
        const backspaceKey = document.getElementById('backspaceKey');
        const decimalKey = document.getElementById('decimalKey');
        const allTabs = [tabReceita, tabDespesa, tabCorridas, tabKm];

        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;

        // Format display based on type
        function formatDisplayValue() {
            if (isCurrency) {
                const numValue = parseFloat(rawValue) / 100;
                return numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return parseInt(rawValue).toLocaleString('pt-BR');
            }
        }

        // Update amount display
        function updateAmountDisplay() {
            amountInput.value = formatDisplayValue();
        }

        // Reset value
        function resetValue() {
            rawValue = '0';
            updateAmountDisplay();
        }

        // Handle numeric keypad
        numKeys.forEach(key => {
            key.addEventListener('click', () => {
                const value = key.dataset.value;

                // Skip decimal for non-currency
                if (value === ',' && !isCurrency) return;

                // For currency, treat as cents
                if (isCurrency) {
                    if (rawValue === '0') {
                        rawValue = value;
                    } else if (rawValue.length < 12) {
                        rawValue = rawValue + value;
                    }
                } else {
                    // For integer values (corridas, km)
                    if (rawValue === '0') {
                        rawValue = value;
                    } else if (rawValue.length < 6) {
                        rawValue = rawValue + value;
                    }
                }
                updateAmountDisplay();
            });
        });

        // Handle backspace
        backspaceKey.addEventListener('click', () => {
            if (rawValue.length > 1) {
                rawValue = rawValue.slice(0, -1);
            } else {
                rawValue = '0';
            }
            updateAmountDisplay();
        });

        // Switch tab
        function switchTab(type) {
            currentType = type;
            resetValue();

            // Update tab styles
            allTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.add('text-slate-500', 'dark:text-slate-400');
            });

            // Hide all sections
            incomeCategories.classList.add('hidden');
            expenseCategories.classList.add('hidden');
            infoCard.classList.add('hidden');
            decimalKey.classList.remove('hidden');

            // Configure based on type
            switch (type) {
                case 'income':
                    tabReceita.classList.add('active');
                    tabReceita.classList.remove('text-slate-500', 'dark:text-slate-400');
                    amountLabel.textContent = 'Valor da receita';
                    amountPrefix.textContent = 'R$';
                    amountPrefix.classList.remove('hidden');
                    incomeCategories.classList.remove('hidden');
                    saveBtnText.textContent = 'Salvar Receita';
                    saveBtn.className = 'w-full rounded-xl bg-primary py-4 text-center text-base font-bold text-slate-900 shadow-lg shadow-primary/20 hover:bg-[#34f574] transition-colors active:scale-[0.98] flex items-center justify-center gap-2';
                    isCurrency = true;
                    break;
                case 'expense':
                    tabDespesa.classList.add('active');
                    tabDespesa.classList.remove('text-slate-500', 'dark:text-slate-400');
                    amountLabel.textContent = 'Valor da despesa';
                    amountPrefix.textContent = 'R$';
                    amountPrefix.classList.remove('hidden');
                    expenseCategories.classList.remove('hidden');
                    saveBtnText.textContent = 'Salvar Despesa';
                    saveBtn.className = 'w-full rounded-xl bg-red-500 py-4 text-center text-base font-bold text-white shadow-lg shadow-red-500/20 hover:bg-red-600 transition-colors active:scale-[0.98] flex items-center justify-center gap-2';
                    isCurrency = true;
                    break;
                case 'corridas':
                    tabCorridas.classList.add('active');
                    tabCorridas.classList.remove('text-slate-500', 'dark:text-slate-400');
                    amountLabel.textContent = 'Quantidade de corridas';
                    amountPrefix.textContent = 'Corridas';
                    amountPrefix.classList.remove('hidden');
                    infoCard.classList.remove('hidden');
                    infoTitle.textContent = 'Registrar Corridas';
                    infoText.textContent = 'Este lancamento sera contabilizado nas suas metas de corridas.';
                    saveBtnText.textContent = 'Salvar Corridas';
                    saveBtn.className = 'w-full rounded-xl bg-blue-500 py-4 text-center text-base font-bold text-white shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition-colors active:scale-[0.98] flex items-center justify-center gap-2';
                    isCurrency = false;
                    decimalKey.classList.add('hidden');
                    break;
                case 'km':
                    tabKm.classList.add('active');
                    tabKm.classList.remove('text-slate-500', 'dark:text-slate-400');
                    amountLabel.textContent = 'Quilometros rodados';
                    amountPrefix.textContent = 'KM';
                    amountPrefix.classList.remove('hidden');
                    infoCard.classList.remove('hidden');
                    infoTitle.textContent = 'Registrar Quilometragem';
                    infoText.textContent = 'Este lancamento sera contabilizado nas suas metas de quilometragem.';
                    saveBtnText.textContent = 'Salvar Quilometragem';
                    saveBtn.className = 'w-full rounded-xl bg-purple-500 py-4 text-center text-base font-bold text-white shadow-lg shadow-purple-500/20 hover:bg-purple-600 transition-colors active:scale-[0.98] flex items-center justify-center gap-2';
                    isCurrency = false;
                    decimalKey.classList.add('hidden');
                    break;
            }

            updateAmountDisplay();
        }

        // Tab click events
        tabReceita.addEventListener('click', () => switchTab('income'));
        tabDespesa.addEventListener('click', () => switchTab('expense'));
        tabCorridas.addEventListener('click', () => switchTab('corridas'));
        tabKm.addEventListener('click', () => switchTab('km'));

        // Category selection
        function setupCategorySelection(categories, borderColor) {
            categories.forEach(cat => {
                cat.addEventListener('click', () => {
                    categories.forEach(c => {
                        c.classList.remove('selected');
                        c.classList.remove('border-primary', 'border-red-500');
                        c.classList.add('border-transparent');
                    });
                    cat.classList.add('selected');
                    cat.classList.remove('border-transparent');
                    cat.classList.add(borderColor);
                });
            });
        }

        const incomeCats = document.querySelectorAll('.income-cat');
        const expenseCats = document.querySelectorAll('.expense-cat');
        setupCategorySelection(incomeCats, 'border-primary');
        setupCategorySelection(expenseCats, 'border-red-500');

        // Get selected category
        function getSelectedCategory() {
            if (currentType === 'corridas') return 'corridas';
            if (currentType === 'km') return 'km';

            const selector = currentType === 'income' ? 'income-category' : 'expense-category';
            const checked = document.querySelector(`input[name="${selector}"]:checked`);
            return checked ? checked.value : null;
        }

        // Get numeric value
        function getNumericValue() {
            if (isCurrency) {
                return parseFloat(rawValue) / 100;
            }
            return parseInt(rawValue) || 0;
        }

        // Flag to prevent double submission
        let isSaving = false;

        // Save handler
        saveBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // Prevent double click
            if (isSaving) {
                console.log('Salvamento ja em andamento, ignorando clique');
                return;
            }

            console.log('Botao salvar clicado');

            const value = getNumericValue();
            console.log('Valor:', value, 'Tipo:', currentType);

            // Validate
            if (value <= 0) {
                showToast('Digite um valor valido', 'error');
                return;
            }

            const category = getSelectedCategory();
            console.log('Categoria:', category);

            if (!category) {
                showToast('Selecione uma categoria', 'error');
                return;
            }

            // Set saving flag and disable button
            isSaving = true;
            saveBtn.disabled = true;
            const originalText = saveBtnText.textContent;
            saveBtnText.textContent = 'Salvando...';

            try {
                const date = new Date(dateInput.value + 'T12:00:00');
                const description = descriptionInput.value.trim();

                // Map type to transaction type
                let transactionType;
                let goalCategory = null;

                switch (currentType) {
                    case 'income':
                        transactionType = 'income';
                        goalCategory = 'receita';
                        break;
                    case 'expense':
                        transactionType = 'expense';
                        break;
                    case 'corridas':
                        transactionType = 'corridas';
                        goalCategory = 'corridas';
                        break;
                    case 'km':
                        transactionType = 'km';
                        goalCategory = 'km';
                        break;
                }

                console.log('Salvando transacao:', {
                    type: transactionType,
                    amount: value,
                    category: category,
                    date: date,
                    description: description
                });

                // Save transaction to Firebase
                const transactionId = await addTransaction({
                    type: transactionType,
                    amount: value,
                    category: category,
                    date: date,
                    description: description || null
                });

                console.log('Transacao salva com ID:', transactionId);

                // Update goals progress for applicable types
                if (goalCategory) {
                    console.log('Atualizando metas da categoria:', goalCategory);
                    await updateGoalsProgress(value, goalCategory);
                }

                // Success message based on type
                let successMessage;
                switch (currentType) {
                    case 'income': successMessage = 'Receita salva com sucesso!'; break;
                    case 'expense': successMessage = 'Despesa salva com sucesso!'; break;
                    case 'corridas': successMessage = `${value} corrida(s) registrada(s)!`; break;
                    case 'km': successMessage = `${value} km registrado(s)!`; break;
                }

                showToast(successMessage, 'success');

                // Reset form
                resetValue();
                descriptionInput.value = '';
                dateInput.value = today;

                // Go back after delay
                setTimeout(() => {
                    window.history.back();
                }, 1500);

            } catch (error) {
                console.error('Erro ao salvar:', error);
                showToast('Erro ao salvar. Verifique sua conexao e tente novamente.', 'error');
                saveBtn.disabled = false;
                saveBtnText.textContent = originalText;
                isSaving = false;
            }
        });

        // Navigation
        backBtn.addEventListener('click', () => window.history.back());
        closeBtn.addEventListener('click', () => window.location.href = '/user/Dashboard/dash.html');

        // Initialize
        updateAmountDisplay();
        console.log('Pagina de lancamento inicializada');
    </script>
</body>
</html>
