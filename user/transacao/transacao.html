<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Transações - GPS Financeiro</title>
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png"/>
    <!-- Resource Hints -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com"/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <!-- Theme Persistence -->
    <script src="/shared/theme.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Shared Styles -->
    <link rel="stylesheet" href="/shared/styles.css"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/shared/tailwind-config.js"></script>
    <style>
        .filter-chip.active {
            background-color: #FFD700;
            color: #000000;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display flex flex-col h-screen overflow-hidden">
    <!-- Top App Bar -->
    <header class="flex-none px-4 pt-12 pb-2 bg-background-light dark:bg-background-dark z-20">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
                <a href="/user/Dashboard/dash.html" class="flex items-center justify-center w-10 h-10 -ml-2 rounded-full text-slate-600 dark:text-white hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back</span>
                </a>
                <h2 class="text-xl font-bold leading-tight tracking-tight">Transações</h2>
            </div>
            <div class="flex items-center gap-2">
                <button id="searchBtn" class="flex items-center justify-center w-10 h-10 rounded-full text-slate-600 dark:text-white hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">search</span>
                </button>
                <button id="calendarBtn" class="flex items-center justify-center w-10 h-10 rounded-full text-slate-600 dark:text-white hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">calendar_month</span>
                </button>
            </div>
        </div>
        <!-- Search Bar (hidden by default) -->
        <div id="searchBar" class="hidden mt-2">
            <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                <input
                    id="searchInput"
                    type="text"
                    placeholder="Buscar transações..."
                    class="w-full bg-white dark:bg-surface-dark rounded-xl pl-10 pr-4 py-3 text-sm border-none focus:ring-2 focus:ring-primary"
                />
            </div>
        </div>
        <!-- Date Range Picker (hidden by default) -->
        <div id="dateRangePicker" class="hidden mt-2 flex gap-2">
            <div class="flex-1">
                <label class="text-xs text-slate-500">De</label>
                <input id="startDate" type="date" class="w-full bg-white dark:bg-surface-dark rounded-lg px-3 py-2 text-sm border-none"/>
            </div>
            <div class="flex-1">
                <label class="text-xs text-slate-500">Até</label>
                <input id="endDate" type="date" class="w-full bg-white dark:bg-surface-dark rounded-lg px-3 py-2 text-sm border-none"/>
            </div>
            <button id="applyDateFilter" class="bg-primary text-background-dark rounded-lg px-4 py-2 font-bold text-sm self-end">
                Filtrar
            </button>
        </div>
    </header>

    <!-- Main Scrollable Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar pb-32 relative">
        <!-- Summary Stats Card -->
        <div class="px-4 py-2">
            <div class="relative overflow-hidden rounded-xl bg-surface-dark p-5 shadow-lg">
                <div class="absolute -right-8 -top-8 h-32 w-32 rounded-full bg-primary/20 blur-3xl"></div>
                <div class="relative z-10 flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <p id="periodLabel" class="text-white/80 text-sm font-medium">Saldo do período</p>
                        <div id="trendBadge" class="hidden items-center gap-1 bg-primary/10 px-2 py-1 rounded-full">
                            <span id="trendValue" class="text-primary text-xs font-bold"></span>
                            <span class="material-symbols-outlined text-primary text-[14px]">trending_up</span>
                        </div>
                    </div>
                    <p id="balanceValue" class="text-white tracking-tight text-3xl font-bold">R$ 0,00</p>
                    <div class="flex gap-4 mt-2">
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-primary text-[16px]">arrow_downward</span>
                            <span id="incomeValue" class="text-white/60 text-xs">R$ 0,00 Rec.</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-red-400 text-[16px]">arrow_upward</span>
                            <span id="expenseValue" class="text-white/60 text-xs">R$ 0,00 Desp.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Filter Chips -->
        <div class="sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md pt-4 pb-2 border-b border-gray-200 dark:border-white/5">
            <div class="flex gap-2 px-4 overflow-x-auto no-scrollbar pb-2">
                <button class="filter-chip active flex h-8 shrink-0 items-center justify-center px-4 rounded-full transition-all" data-filter="all">
                    <span class="text-sm">Todos</span>
                </button>
                <button class="filter-chip flex h-8 shrink-0 items-center justify-center px-4 rounded-full bg-white dark:bg-surface-dark border border-gray-200 dark:border-transparent transition-all" data-filter="income">
                    <span class="text-sm text-slate-600 dark:text-white">Receitas</span>
                </button>
                <button class="filter-chip flex h-8 shrink-0 items-center justify-center px-4 rounded-full bg-white dark:bg-surface-dark border border-gray-200 dark:border-transparent transition-all" data-filter="expense">
                    <span class="text-sm text-slate-600 dark:text-white">Despesas</span>
                </button>
            </div>
        </div>

        <!-- Transaction List -->
        <div id="transactionList" class="flex flex-col mt-2 px-2">
            <!-- Loading State -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-12">
                <span class="material-symbols-outlined text-4xl text-slate-400 animate-spin">progress_activity</span>
                <p class="text-slate-400 mt-2">Carregando transações...</p>
            </div>
            <!-- Empty State (hidden by default) -->
            <div id="emptyState" class="hidden flex-col items-center justify-center py-12">
                <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600">receipt_long</span>
                <p class="text-slate-400 mt-4 text-center">Nenhuma transação encontrada</p>
                <a href="/user/Lancamento/lancamento.html" class="mt-4 text-primary font-semibold text-sm hover:underline">
                    Adicionar primeira transação
                </a>
            </div>
            <!-- Transactions will be inserted here -->
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none bg-white dark:bg-background-dark border-t border-gray-200 dark:border-white/5 px-6 pt-3 pb-6">
        <div class="flex justify-between items-end">
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/Dashboard/dash.html">
                <span class="material-symbols-outlined text-[26px]">home</span>
                <span class="text-[10px] font-medium">Início</span>
            </a>
            <a class="flex flex-col items-center gap-1 w-12 text-slate-900 dark:text-primary transition-colors" href="/user/transacao/transacao.html">
                <span class="material-symbols-outlined text-[26px]" style="font-variation-settings: 'FILL' 1;">receipt_long</span>
                <span class="text-[10px] font-medium">Extrato</span>
            </a>
            <!-- Central FAB -->
            <div class="relative -top-3">
                <a href="/user/Lancamento/lancamento.html" class="flex items-center justify-center w-14 h-14 rounded-full bg-primary shadow-lg shadow-primary/30 text-background-dark hover:scale-105 active:scale-95 transition-all">
                    <span class="material-symbols-outlined text-[32px]">add</span>
                </a>
            </div>
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/metas/meta.html">
                <span class="material-symbols-outlined text-[26px]">flag</span>
                <span class="text-[10px] font-medium">Metas</span>
            </a>
            <a class="flex flex-col items-center gap-1 w-12 text-gray-400 dark:text-gray-500 hover:text-slate-900 dark:hover:text-white transition-colors" href="/user/configuracoes/config.html">
                <span class="material-symbols-outlined text-[26px]">settings</span>
                <span class="text-[10px] font-medium">Ajustes</span>
            </a>
        </div>
    </nav>

    <!-- Transaction Options Modal -->
    <div id="optionsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm">
            <h3 id="optionsTitle" class="text-lg font-bold mb-4">Opções</h3>
            <div class="space-y-3">
                <button id="editTransactionBtn" class="w-full py-3 rounded-xl bg-primary/10 text-primary font-semibold flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">edit</span>
                    Editar Transação
                </button>
                <button id="deleteTransactionBtn" class="w-full py-3 rounded-xl bg-red-500/10 text-red-500 font-semibold flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">delete</span>
                    Excluir Transação
                </button>
                <button id="cancelOptionsBtn" class="w-full py-3 rounded-xl bg-slate-100 dark:bg-white/10 font-semibold">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Editar Transação</h3>
            <form id="editForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1">Valor</label>
                    <input type="text" id="editAmount" inputmode="decimal" class="w-full bg-slate-100 dark:bg-white/5 rounded-xl px-4 py-3 border-none focus:ring-2 focus:ring-primary text-lg font-bold"/>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1">Data</label>
                    <input type="date" id="editDate" class="w-full bg-slate-100 dark:bg-white/5 rounded-xl px-4 py-3 border-none focus:ring-2 focus:ring-primary"/>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1">Descrição (Opcional)</label>
                    <input type="text" id="editDescription" class="w-full bg-slate-100 dark:bg-white/5 rounded-xl px-4 py-3 border-none focus:ring-2 focus:ring-primary" placeholder="Adicionar nota..."/>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancelEditBtn" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-white/10 font-semibold">
                        Cancelar
                    </button>
                    <button type="submit" id="saveEditBtn" class="flex-1 py-3 rounded-xl bg-primary text-background-dark font-semibold">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2">Excluir transação?</h3>
            <p class="text-slate-500 text-sm mb-2">Esta ação não pode ser desfeita.</p>
            <p id="deleteImpactInfo" class="text-xs text-amber-500 mb-4 hidden"></p>
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-white/10 font-semibold">
                    Cancelar
                </button>
                <button id="confirmDelete" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-semibold">
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- JavaScript -->
    <script type="module">
        import { requireAuth } from '/js/firebase-config.js';
        import { getTransactions, getTransaction, deleteTransaction, updateTransaction, decrementGoalsProgress, updateGoalsProgress, getGoalCategoryForTransaction } from '/js/db.js';
        import { showToast, formatCurrency, formatDate, formatRelativeDate } from '/js/utils.js';

        // Wait for auth - must complete before proceeding
        const user = await requireAuth();
        if (!user) {
            console.error('Usuário não autenticado');
            throw new Error('Not authenticated');
        }

        // State
        let allTransactions = [];
        let filteredTransactions = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let startDate = null;
        let endDate = null;
        let transactionToDelete = null;
        let selectedTransaction = null;

        // Category configs
        const categoryConfig = {
            // Income categories
            uber: { icon: 'directions_car', label: 'Uber', bgClass: 'bg-black text-white' },
            '99': { icon: 'local_taxi', label: '99', bgClass: 'bg-yellow-400 text-black' },
            indrive: { icon: 'two_wheeler', label: 'Indrive', bgClass: 'bg-green-500 text-white' },
            particular: { icon: 'person', label: 'Particular', bgClass: 'bg-blue-500 text-white' },
            outros_receita: { icon: 'more_horiz', label: 'Outros', bgClass: 'bg-purple-500 text-white' },
            // Expense categories
            combustivel: { icon: 'local_gas_station', label: 'Combustivel', bgClass: 'bg-orange-500 text-white' },
            manutencao: { icon: 'build', label: 'Manutencao', bgClass: 'bg-slate-600 text-white' },
            alimentacao: { icon: 'restaurant', label: 'Alimentacao', bgClass: 'bg-amber-500 text-white' },
            lavagem: { icon: 'local_car_wash', label: 'Lavagem', bgClass: 'bg-cyan-500 text-white' },
            estacionamento: { icon: 'local_parking', label: 'Estacionamento', bgClass: 'bg-indigo-500 text-white' },
            outros_despesa: { icon: 'more_horiz', label: 'Outros', bgClass: 'bg-rose-500 text-white' },
            // Activity categories
            corridas: { icon: 'directions_car', label: 'Corridas', bgClass: 'bg-blue-500 text-white' },
            km: { icon: 'speed', label: 'Quilometragem', bgClass: 'bg-purple-500 text-white' },
        };

        // DOM Elements
        const transactionList = document.getElementById('transactionList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const balanceValue = document.getElementById('balanceValue');
        const incomeValue = document.getElementById('incomeValue');
        const expenseValue = document.getElementById('expenseValue');
        const periodLabel = document.getElementById('periodLabel');
        const searchBtn = document.getElementById('searchBtn');
        const searchBar = document.getElementById('searchBar');
        const searchInput = document.getElementById('searchInput');
        const calendarBtn = document.getElementById('calendarBtn');
        const dateRangePicker = document.getElementById('dateRangePicker');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const applyDateFilter = document.getElementById('applyDateFilter');
        const filterChips = document.querySelectorAll('.filter-chip');
        // Options Modal
        const optionsModal = document.getElementById('optionsModal');
        const optionsTitle = document.getElementById('optionsTitle');
        const editTransactionBtn = document.getElementById('editTransactionBtn');
        const deleteTransactionBtn = document.getElementById('deleteTransactionBtn');
        const cancelOptionsBtn = document.getElementById('cancelOptionsBtn');
        // Edit Modal
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editAmount = document.getElementById('editAmount');
        const editDate = document.getElementById('editDate');
        const editDescription = document.getElementById('editDescription');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        // Delete Modal
        const deleteModal = document.getElementById('deleteModal');
        const deleteImpactInfo = document.getElementById('deleteImpactInfo');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');

        // Load transactions with limit for better performance
        async function loadTransactions() {
            try {
                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');

                const filters = { limit: 100 }; // Limit initial load for performance
                if (startDate) filters.startDate = new Date(startDate);
                if (endDate) filters.endDate = new Date(endDate + 'T23:59:59');

                allTransactions = await getTransactions(filters);
                console.log('Loaded transactions:', allTransactions.length);
                applyFilters();
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Erro ao carregar transações', 'error');
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        // Apply filters
        function applyFilters() {
            console.log('Applying filter:', currentFilter, 'Search:', searchQuery);

            filteredTransactions = allTransactions.filter(t => {
                // Type filter
                if (currentFilter !== 'all') {
                    if (t.type !== currentFilter) return false;
                }
                // Search filter
                if (searchQuery && searchQuery.length > 0) {
                    const query = searchQuery.toLowerCase();
                    const cat = categoryConfig[t.category];
                    const catLabel = cat ? cat.label.toLowerCase() : '';
                    const desc = (t.description || '').toLowerCase();
                    if (!catLabel.includes(query) && !desc.includes(query)) return false;
                }
                return true;
            });

            console.log('Filtered transactions:', filteredTransactions.length);
            renderTransactions();
            updateSummary();
        }

        // Update summary
        function updateSummary() {
            let income = 0;
            let expense = 0;

            filteredTransactions.forEach(t => {
                // Apenas type=income conta como receita
                // Apenas type=expense conta como despesa
                // Tipos corridas e km são registros de atividade, não financeiros
                if (t.type === 'income') income += t.amount;
                else if (t.type === 'expense') expense += t.amount;
            });

            const balance = income - expense;
            balanceValue.textContent = formatCurrency(balance);
            incomeValue.textContent = formatCurrency(income) + ' Rec.';
            expenseValue.textContent = formatCurrency(expense) + ' Desp.';

            // Update period label
            if (startDate || endDate) {
                periodLabel.textContent = 'Saldo filtrado';
            } else {
                const now = new Date();
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                periodLabel.textContent = `Saldo de ${monthNames[now.getMonth()]}`;
            }
        }

        // Render transactions
        function renderTransactions() {
            // Clear previous content except loading/empty states
            const children = Array.from(transactionList.children);
            children.forEach(child => {
                if (child.id !== 'loadingState' && child.id !== 'emptyState') {
                    child.remove();
                }
            });

            if (filteredTransactions.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                return;
            }

            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');

            // Group by date
            const grouped = {};
            filteredTransactions.forEach(t => {
                const dateKey = t.date.toDate ? t.date.toDate().toDateString() : new Date(t.date).toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // Sort dates descending
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            // Render each group
            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const dateLabel = formatRelativeDate(date);

                // Section header
                const header = document.createElement('div');
                header.className = 'flex items-center gap-4 px-4 py-3';
                header.innerHTML = `
                    <h4 class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">${dateLabel}</h4>
                    <div class="h-[1px] flex-1 bg-gray-200 dark:bg-surface-dark"></div>
                `;
                transactionList.appendChild(header);

                // Transactions for this date
                grouped[dateKey].forEach(t => {
                    const cat = categoryConfig[t.category] || { icon: 'receipt', label: t.category, bgClass: 'bg-slate-500 text-white' };
                    const isIncome = t.type === 'income';
                    const isCorridas = t.type === 'corridas';
                    const isKm = t.type === 'km';
                    const isActivity = isCorridas || isKm;

                    // Determine styling based on type
                    let amountClass, amountPrefix, iconBgClass, displayValue;
                    if (isIncome) {
                        amountClass = 'text-green-500';
                        amountPrefix = '+';
                        iconBgClass = cat.bgClass;
                        displayValue = formatCurrency(t.amount);
                    } else if (isCorridas) {
                        amountClass = 'text-blue-500';
                        amountPrefix = '';
                        iconBgClass = 'bg-blue-50 dark:bg-blue-500/10 text-blue-500';
                        displayValue = `${t.amount} corrida${t.amount !== 1 ? 's' : ''}`;
                    } else if (isKm) {
                        amountClass = 'text-purple-500';
                        amountPrefix = '';
                        iconBgClass = 'bg-purple-50 dark:bg-purple-500/10 text-purple-500';
                        displayValue = `${t.amount} km`;
                    } else {
                        amountClass = 'text-red-500';
                        amountPrefix = '-';
                        iconBgClass = 'bg-red-50 dark:bg-red-500/10 text-red-500';
                        displayValue = formatCurrency(t.amount);
                    }

                    const time = t.date.toDate ? t.date.toDate() : new Date(t.date);
                    const timeStr = time.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    const item = document.createElement('div');
                    item.className = 'group flex items-center justify-between gap-4 px-4 py-3 hover:bg-black/5 dark:hover:bg-white/5 cursor-pointer transition-colors rounded-lg active:scale-[0.98]';
                    item.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="flex items-center justify-center rounded-xl shrink-0 size-12 ${iconBgClass}">
                                <span class="material-symbols-outlined">${cat.icon}</span>
                            </div>
                            <div class="flex flex-col justify-center">
                                <p class="text-slate-900 dark:text-white text-base font-semibold line-clamp-1">${cat.label}</p>
                                <p class="text-slate-500 dark:text-slate-400 text-sm line-clamp-1">${timeStr}${t.description ? ' • ' + t.description : ''}</p>
                            </div>
                        </div>
                        <div class="shrink-0 text-right flex items-center gap-2">
                            <p class="${amountClass} text-base font-bold">${amountPrefix}${amountPrefix ? ' ' : ''}${displayValue}</p>
                            <span class="material-symbols-outlined text-slate-400 text-[20px]">chevron_right</span>
                        </div>
                    `;
                    transactionList.appendChild(item);

                    // Click handler to open options modal
                    item.addEventListener('click', () => {
                        selectedTransaction = t;
                        optionsTitle.textContent = cat.label;
                        optionsModal.classList.remove('hidden');
                        optionsModal.classList.add('flex');
                    });
                });
            });

            updateSummary();
        }

        // Search functionality
        searchBtn.addEventListener('click', () => {
            searchBar.classList.toggle('hidden');
            dateRangePicker.classList.add('hidden');
            if (!searchBar.classList.contains('hidden')) {
                searchInput.focus();
            }
        });

        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            applyFilters();
        });

        // Date range filter
        calendarBtn.addEventListener('click', () => {
            dateRangePicker.classList.toggle('hidden');
            searchBar.classList.add('hidden');
        });

        applyDateFilter.addEventListener('click', () => {
            startDate = startDateInput.value || null;
            endDate = endDateInput.value || null;
            loadTransactions();
            dateRangePicker.classList.add('hidden');
        });

        // Filter chips
        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                applyFilters();
            });
        });

        // ========================================
        // Options Modal Handlers
        // ========================================
        function closeOptionsModal() {
            optionsModal.classList.add('hidden');
            optionsModal.classList.remove('flex');
        }

        cancelOptionsBtn.addEventListener('click', closeOptionsModal);
        optionsModal.addEventListener('click', (e) => {
            if (e.target === optionsModal) closeOptionsModal();
        });

        // Edit button handler
        editTransactionBtn.addEventListener('click', () => {
            if (!selectedTransaction) return;
            closeOptionsModal();

            // Get transaction date
            const txDate = selectedTransaction.date.toDate ? selectedTransaction.date.toDate() : new Date(selectedTransaction.date);
            const dateStr = txDate.toISOString().split('T')[0];

            // Check if currency or integer value
            const isCurrency = selectedTransaction.type === 'income' || selectedTransaction.type === 'expense';

            // Populate edit form
            if (isCurrency) {
                editAmount.value = selectedTransaction.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                editAmount.value = selectedTransaction.amount.toLocaleString('pt-BR');
            }
            editDate.value = dateStr;
            editDescription.value = selectedTransaction.description || '';

            // Show edit modal
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        });

        // Delete button handler
        deleteTransactionBtn.addEventListener('click', () => {
            if (!selectedTransaction) return;
            closeOptionsModal();

            // Show impact info if transaction affects goals
            const goalCategory = getGoalCategoryForTransaction(selectedTransaction.type);
            if (goalCategory) {
                const isCurrency = selectedTransaction.type === 'income';
                const valueDisplay = isCurrency ? formatCurrency(selectedTransaction.amount) : `${selectedTransaction.amount}`;
                deleteImpactInfo.textContent = `Isso irá remover ${valueDisplay} do progresso das suas metas de ${goalCategory}.`;
                deleteImpactInfo.classList.remove('hidden');
            } else {
                deleteImpactInfo.classList.add('hidden');
            }

            // Show delete modal
            transactionToDelete = selectedTransaction.id;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        });

        // ========================================
        // Edit Modal Handlers
        // ========================================
        function closeEditModal() {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }

        cancelEditBtn.addEventListener('click', closeEditModal);
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });

        // Parse value from formatted string
        function parseValue(str) {
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Save edit handler
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedTransaction) return;

            const newAmount = parseValue(editAmount.value);
            if (newAmount <= 0) {
                showToast('Digite um valor válido', 'error');
                return;
            }

            const newDate = editDate.value;
            if (!newDate) {
                showToast('Selecione uma data', 'error');
                return;
            }

            try {
                const oldAmount = selectedTransaction.amount;
                const goalCategory = getGoalCategoryForTransaction(selectedTransaction.type);

                // Update transaction
                await updateTransaction(selectedTransaction.id, {
                    amount: newAmount,
                    date: newDate + 'T12:00:00',
                    description: editDescription.value.trim() || null
                });

                // Update goal progress if applicable
                if (goalCategory) {
                    const difference = newAmount - oldAmount;
                    if (difference > 0) {
                        // Value increased - add to goals
                        await updateGoalsProgress(difference, goalCategory);
                    } else if (difference < 0) {
                        // Value decreased - subtract from goals
                        await decrementGoalsProgress(Math.abs(difference), goalCategory);
                    }
                }

                showToast('Transação atualizada!', 'success');
                closeEditModal();
                selectedTransaction = null;
                await loadTransactions();
            } catch (error) {
                console.error('Error updating transaction:', error);
                showToast('Erro ao atualizar', 'error');
            }
        });

        // ========================================
        // Delete Modal Handlers
        // ========================================
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
            transactionToDelete = null;
            deleteImpactInfo.classList.add('hidden');
        }

        cancelDelete.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) closeDeleteModal();
        });

        confirmDelete.addEventListener('click', async () => {
            if (!transactionToDelete || !selectedTransaction) return;

            try {
                const goalCategory = getGoalCategoryForTransaction(selectedTransaction.type);
                const amount = selectedTransaction.amount;

                // Delete transaction
                await deleteTransaction(transactionToDelete);

                // Decrement goal progress if applicable
                if (goalCategory && amount > 0) {
                    await decrementGoalsProgress(amount, goalCategory);
                }

                showToast('Transação excluída', 'success');
                closeDeleteModal();
                selectedTransaction = null;
                await loadTransactions();
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showToast('Erro ao excluir', 'error');
            }
        });

        // Initialize
        loadTransactions();
    </script>
</body>
</html>
