<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Setup Admin - GPS Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #102216; color: white; font-family: system-ui, sans-serif; }
        .btn { background: #13ec5b; color: #102216; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn:hover { background: #34f574; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input { background: #1a2c20; border: 1px solid #2a3c30; padding: 12px; border-radius: 8px; width: 100%; color: white; }
        .log { background: #1a2c20; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto; }
        .success { color: #13ec5b; }
        .error { color: #ef4444; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full space-y-6">
        <div class="text-center">
            <h1 class="text-2xl font-bold mb-2">Setup Administrador</h1>
            <p class="text-gray-400 text-sm">Crie a conta de administrador inicial</p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Email</label>
                <input type="email" id="email" class="input" value="admin@gmail.com" />
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Senha</label>
                <input type="password" id="password" class="input" value="123456" />
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Nome</label>
                <input type="text" id="name" class="input" value="Administrador" />
            </div>
        </div>

        <button id="createBtn" class="btn w-full">Criar Administrador</button>

        <div id="log" class="log hidden"></div>

        <p class="text-center text-xs text-gray-500">
            Após criar, acesse <a href="/admin/loginadmin/loginadmin.html" class="text-primary underline">/admin/loginadmin</a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAWhjDiTyUSmAwgA0d2T05Op_dobKXcZlk",
            authDomain: "gps-financeiro-e39fd.firebaseapp.com",
            projectId: "gps-financeiro-e39fd",
            storageBucket: "gps-financeiro-e39fd.firebasestorage.app",
            messagingSenderId: "705482332766",
            appId: "1:705482332766:web:635524be0df72a894372cf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const nameInput = document.getElementById('name');
        const createBtn = document.getElementById('createBtn');
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            logDiv.classList.remove('hidden');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()} - ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        createBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const name = nameInput.value.trim();

            if (!email || !password || !name) {
                log('Preencha todos os campos', 'error');
                return;
            }

            createBtn.disabled = true;
            createBtn.textContent = 'Criando...';

            try {
                // 1. Criar usuário no Auth
                log('Criando usuário no Firebase Auth...');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                log(`Usuário criado! UID: ${user.uid}`, 'success');

                // 2. Atualizar perfil
                log('Atualizando perfil...');
                await updateProfile(user, { displayName: name });
                log('Perfil atualizado!', 'success');

                // 3. Criar documento do usuário
                log('Criando documento do usuário...');
                await setDoc(doc(db, 'users', user.uid), {
                    email: email,
                    name: name,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                log('Documento do usuário criado!', 'success');

                // 4. Criar documento admin
                log('Criando documento de administrador...');
                await setDoc(doc(db, 'admins', user.uid), {
                    email: email,
                    name: name,
                    active: true,
                    createdAt: serverTimestamp()
                });
                log('Documento admin criado!', 'success');

                log('');
                log('========================================', 'success');
                log('ADMINISTRADOR CRIADO COM SUCESSO!', 'success');
                log(`Email: ${email}`, 'success');
                log(`Senha: ${password}`, 'success');
                log('========================================', 'success');
                log('');
                log('Redirecionando para login em 3 segundos...');

                setTimeout(() => {
                    window.location.href = '/admin/loginadmin/loginadmin.html';
                }, 3000);

            } catch (error) {
                console.error(error);
                if (error.code === 'auth/email-already-in-use') {
                    log('Este email já está em uso. Tente fazer login ou use outro email.', 'error');
                } else if (error.code === 'auth/weak-password') {
                    log('Senha muito fraca. Use pelo menos 6 caracteres.', 'error');
                } else {
                    log(`Erro: ${error.message}`, 'error');
                }
                createBtn.disabled = false;
                createBtn.textContent = 'Criar Administrador';
            }
        });
    </script>
</body>
</html>
